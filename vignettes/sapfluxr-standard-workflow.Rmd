---
title: "Standard Sap Flow Workflow (Spreadsheet Replication)"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Standard Sap Flow Workflow}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Introduction

This vignette replicates the standard 9-step workflow defined in the *Sap flow data processing template* spreadsheet. It guides you from raw ICT SFM1x data to daily whole-tree water use.

## The 9-Step Workflow

1.  **Raw HPV ($V_h$)**: Calculate Heat Pulse Velocity.
2.  **Zero Offset**: Correct for baseline shifts.
3.  **Spacing Correction**: Correct for probe misalignment.
4.  **Wound Correction ($V_c$)**: Correct for mechanical wounding.
5.  **Flux Density ($J_v$)**: Convert velocity to flux density.
6.  **Sap Flux ($Q$)**: Integrate flux density over sapwood area.
7.  **Total Flux ($Q_p$)**: Sum instantaneous flow.
8.  **Mean Flux Density ($Q_{ps}$)**: Weighted average flux density.
9.  **Daily Totals**: Aggregate to daily water use.

```{r setup}
library(sapfluxr)
library(dplyr)
library(ggplot2)
```

---

# Step 1: Raw Heat Pulse Velocity ($V_h$)

Import the raw data and calculate initial velocities.

```{r step1}
# 1. Import Data
# Automatically detects format (CSV, ICT JSON, etc.)
# Note: Ensure you have sample data available or use your own file path
data_file <- system.file("extdata", "sample_data.csv", package = "sapfluxr")
if (data_file == "") {
  # Fallback for development/testing if package isn't installed yet
  # Create dummy data if needed, or user should provide path
  message("Sample data not found. Please provide path to your data file.")
} else {
  raw_data <- read_heat_pulse_data(data_file)
}

# 2. Configure Wood Properties (Initial)
# Needed for thermal diffusivity (k) in HPV calculation
wood_props <- load_wood_properties("eucalyptus")

# 3. Calculate Raw Vh
# Using standard HRM method (can also add MHR, Tmax, etc.)
# Only run if raw_data exists
if (exists("raw_data")) {
  vh_raw <- calc_heat_pulse_velocity(
    raw_data,
    methods = c("HRM", "MHR"),
    wood_properties = wood_props
  )
  
  # Preview
  head(vh_raw)
}
```

---

# Step 2 & 3: Spacing & Zero Offset Correction ($V_h$)

Correct for probe misalignment and zero offsets.

**Method A: Heartwood Reference (Preferred)**
If the inner sensor is in non-conducting heartwood, use it as a continuous zero reference.

```{r step2_heartwood, eval=FALSE}
# Check availability
check <- check_heartwood_reference_available(
  probe_config = list(length = 35, inner_sensor = 7.5),
  sapwood_depth = 2.0,
  bark_thickness = 0.3
)

if (check$available && exists("vh_raw")) {
  correction <- apply_heartwood_reference_correction(
    vh_raw,
    method = "HRM"
  )
  vh_corrected <- correction$vh_corrected
}
```

**Method B: Manual Zero Periods (Alternative)**
If heartwood reference isn't available, use specific zero-flow periods (e.g., pre-dawn, cut-stem).

```{r step2_manual}
# Example: Apply manual correction
if (exists("vh_raw")) {
  vh_corrected <- apply_spacing_correction_both_sensors(
    vh_raw,
    changepoints = c("2024-01-01"), # Date of installation/change
    method = "HRM"
  )
}
```

---

# Step 4: Wound Correction ($V_c$)

Correct for the physical wound caused by the drill bit. Wounds often expand over time.

```{r step4}
if (exists("vh_corrected")) {
  # Configure Wound Parameters
  wood_props$wound_correction$drill_bit_diameter_mm <- 2.0
  wood_props$wound_correction$wound_addition_mm <- 0.3
  
  # Set dates based on data range
  wood_props$wound_correction$initial_date <- min(vh_corrected$datetime)
  wood_props$wound_correction$final_date <- max(vh_corrected$datetime)
  wood_props$wound_correction$final_diameter_mm <- 4.5 # Measured at removal
  
  # Apply Correction
  vh_wound <- apply_wound_correction(
    vh_corrected,
    wood_properties = wood_props,
    probe_spacing = "5mm" # Standard ICT spacing
  )
  
  # New column 'Vc_cm_hr' added
}
```

---

# Step 5: Sap Flux Density ($J_v$)

Convert corrected velocity ($V_c$) to Sap Flux Density ($J_v$) using wood properties (density, moisture content).

Formula: $J_v = V_c \times Z$

```{r step5}
if (exists("vh_wound")) {
  # Ensure wood properties have density/moisture calculated
  wood_props <- calculate_wood_properties(wood_props)
  
  # Apply Conversion
  flux_density <- apply_flux_conversion(
    vh_wound,
    wood_properties = wood_props,
    velocity_col = "Vc_cm_hr"
  )
  
  # New column 'Jv_cm3_cm2_hr' added
}
```

---

# Step 6: Sap Flux Integration ($Q$)

Integrate the point measurements ($J_v$) over the sapwood cross-sectional area to get flow rates ($Q$).

This uses the **Weighted Average Method** (Hatton et al., 1990), dividing the sapwood into concentric rings corresponding to each sensor.

```{r step6}
# Define Tree Dimensions
dbh <- 25.0           # cm
sapwood_depth <- 2.5  # cm
bark_thickness <- 0.5 # cm

# 1. Calculate Ring Areas
areas <- calc_sapwood_areas(
  dbh = dbh,
  bark_thickness = bark_thickness,
  sapwood_depth = sapwood_depth
)

# View Ring Allocation
print(areas$rings)

# 2. Integrate Flux
# This calculates Q_cm3_hr (L/hr) for the whole tree at each timestamp
if (exists("flux_density")) {
  tree_flux <- calc_sap_flux(
    flux_density,
    sapwood_areas = areas
  )
}
```

---

# Step 7 & 8: Whole Tree Metrics ($Q_p, Q_{ps}$)

Calculate derived whole-tree metrics for comparison.

*   **$Q_p$**: Total Sap Flux (L/hr)
*   **$Q_{ps}$**: Mean Sap Flux Density (normalized by sapwood area)

```{r step78}
if (exists("tree_flux")) {
  # Calculate metrics
  tree_metrics <- apply_sapwood_metrics(
    tree_flux,
    flux_col = "Q_cm3_hr",
    sapwood_area = areas$total_sapwood_area_cm2
  )
  
  # View instantaneous results
  head(tree_metrics)
}
```

---

# Step 9: Daily Aggregation

Sum instantaneous rates to get daily totals.

```{r step9}
if (exists("tree_metrics")) {
  # Aggregate to daily totals
  daily_flux <- aggregate_daily(
    tree_metrics,
    datetime_col = "datetime",
    flux_density_col = "Qps_cm_hr", # For Jvm (Mean Flux Density)
    total_flux_col = "Q_cm3_hr"     # For Qp (Total Flux)
  )
  
  # Result: One row per day
  head(daily_flux)
}
```

# Visualization

Plot the final daily water use.

```{r plot}
if (exists("daily_flux")) {
  ggplot(daily_flux, aes(x = date, y = Qp_daily_L_day)) +
    geom_col(fill = "steelblue") +
    labs(
      title = "Daily Whole-Tree Water Use",
      y = "Total Flow (L/day)",
      x = "Date"
    ) +
    theme_minimal()
}
```
