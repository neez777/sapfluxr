% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/04b_sdma_enhanced.R
\name{calibrate_secondary_method}
\alias{calibrate_secondary_method}
\title{Calibrate Secondary Method to Primary Scale}
\usage{
calibrate_secondary_method(
  data,
  primary = "HRM",
  secondary,
  sensor_position = "outer",
  velocity_col = "Vh_cm_hr",
  breakpoint = NULL,
  handover_pct = 0.5,
  method = c("linear", "quadratic", "auto"),
  min_points = 50,
  create_plots = TRUE
)
}
\arguments{
\item{data}{Data frame or tibble containing heat pulse velocity results.
Must have columns for pulse_id, method, sensor_position, and velocity values.}

\item{primary}{Character. Name of primary method (default: "HRM").}

\item{secondary}{Character. Name of secondary method to calibrate (e.g., "MHR").}

\item{sensor_position}{Character. Which sensor to calibrate ("outer" or "inner").
Default: "outer".}

\item{velocity_col}{Character. Name of velocity column to use for SECONDARY method.
Default: "Vh_cm_hr" (raw velocity). The primary method will automatically use
corrected velocity (Vc_cm_hr) if available, falling back to raw if not.
\strong{CRITICAL}: Calibration must use corrected primary velocity to transfer
spacing/wound corrections to the secondary method.}

\item{breakpoint}{Numeric. Maximum velocity (cm/hr) to use for calibration.
Points above this are excluded. If NULL (default), uses all data where
primary method is available.}

\item{method}{Character. Regression type: "linear" (default) or "quadratic".
Quadratic matches Tim's Excel approach for MHR calibration.}

\item{min_points}{Numeric. Minimum number of points required for valid
calibration (default: 50).}

\item{create_plots}{Logical. Whether to create diagnostic scatter plots
showing the calibration fit (default: TRUE).}
}
\value{
A list (class "method_calibration_sdma") with components:
\code{coefficients} (regression coefficients), \code{fit_type} ("linear"
or "quadratic"), \code{r_squared} (RÂ² of fit), \code{rmse} (root mean
squared error), \code{n_points} (calibration points used), \code{breakpoint}
(velocity threshold if specified), \code{transformation_function} (function
to apply calibration), \code{calibrated_data} (data with calibrated column),
\code{calibration_plot} (diagnostic plot if requested), \code{primary_method},
\code{secondary_method}, and \code{sensor_position}
}
\description{
Aligns a secondary heat pulse velocity method (e.g., MHR) to the primary
method's scale (typically HRM) using linear or quadratic regression fitted
to the overlap region where both methods are valid.
}
\details{
\strong{Purpose:}

This function solves the "volcano effect" - discontinuities that occur when
switching between methods without calibration. The secondary method may measure
on a different scale or have an offset relative to the primary method, causing
sudden drops/jumps in velocity time series.

\strong{Calibration Process:}

\enumerate{
\item Detect corrected velocity column (Vc_cm_hr) for primary method
\item Merge primary (corrected) and secondary (raw) method data by pulse_id
\item Filter to calibration region (low-medium flows where both work)
\item Fit regression: Primary_Corrected ~ Secondary_Raw
\item Create transformation function to transfer corrections to secondary
}

\strong{Correction Transfer:}

When the primary method (HRM) has been spacing/wound corrected, calibration
against the corrected values mathematically "transfers" these corrections to
the secondary method. This ensures continuity when switching between methods.

\strong{When to Use Linear vs. Quadratic:}

\itemize{
\item \strong{Linear}: Simple offset/scale differences between methods
\item \strong{Quadratic}: When relationship curves (Tim's Excel uses this for MHR)
}

The function automatically uses the best fit if method = "auto".

\strong{Volcano Effect:}

Named for the visual pattern in plots where daily peak velocities appear to
"drop into a crater" when switching from calibrated HRM to uncalibrated MHR.
Calibration eliminates this by ensuring continuity at the switching boundary.
}
\examples{
\dontrun{
# Calibrate MHR to HRM scale using quadratic regression
calibration <- calibrate_secondary_method(
  data = vh_results,
  primary = "HRM",
  secondary = "MHR",
  breakpoint = 12,  # Use data below 12 cm/hr for calibration
  method = "quadratic"
)

# Examine calibration quality
print(calibration$r_squared)  # Should be > 0.95 for good calibration
print(calibration$calibration_plot)

# Access calibrated data
calibrated_vh <- calibration$calibrated_data
}

}
\seealso{
Other sDMA functions: 
\code{\link{apply_sdma_switching}()},
\code{\link{auto_select_sdma_strategy}()},
\code{\link{recalculate_peclet}()}
}
\concept{sDMA functions}
