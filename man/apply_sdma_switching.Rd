% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/04b_sdma_enhanced.R
\name{apply_sdma_switching}
\alias{apply_sdma_switching}
\title{Apply sDMA Switching Logic}
\usage{
apply_sdma_switching(
  data,
  vh_data = NULL,
  primary = "HRM",
  secondary = NULL,
  secondary_method = NULL,
  mode = c("peclet", "velocity"),
  switching_mode = NULL,
  threshold = NULL,
  calibrate = TRUE,
  calibration = NULL,
  calibration_breakpoint = NULL,
  calibration_method = "auto",
  sensor_position = "outer",
  velocity_col = "Vh_cm_hr",
  peclet_col = "hrm_peclet_number",
  verbose = TRUE
)
}
\arguments{
\item{data}{Data frame containing heat pulse velocity results with HRM and
at least one secondary method.}

\item{primary}{Character. Primary method name (default: "HRM").}

\item{secondary}{Character. Secondary method name (e.g., "MHR").}

\item{mode}{Character. Switching criterion: "peclet" (default, theory-based)
or "velocity" (empirical, Tim's Excel approach).}

\item{threshold}{Numeric. Threshold value for switching:
\itemize{
\item If mode = "peclet": Peclet number threshold (default: 1.0)
\item If mode = "velocity": Velocity threshold in cm/hr (e.g., 11)
}}

\item{calibrate}{Logical. Whether to calibrate secondary method to primary
scale before switching (default: TRUE). Highly recommended to avoid
"volcano effect" discontinuities.}

\item{calibration_breakpoint}{Numeric. Velocity (cm/hr) below which to fit
calibration. If NULL, uses the switching threshold.}

\item{calibration_method}{Character. "linear", "quadratic", or "auto" (default).}

\item{sensor_position}{Character. Which sensor to process ("outer" or "inner").
Default: "outer".}

\item{velocity_col}{Character. Velocity column name (default: "Vh_cm_hr").}

\item{peclet_col}{Character. Peclet number column name (default: "hrm_peclet_number").}

\item{verbose}{Logical. Print progress messages (default: TRUE).}
}
\value{
Data frame with three new columns added:
\describe{
\item{Vh_sdma}{The final combined velocity after method switching}
\item{sdma_source}{Which method was used: "HRM", "MHR", "MHR_calibrated", etc.}
\item{sdma_trigger}{Reason for switch: "Pe < 1", "Pe >= 1", "Velocity < threshold", etc.}
}
}
\description{
Applies method switching between primary (HRM) and secondary method based on
either Peclet number (theoretical) or velocity threshold (empirical). Optionally
calibrates the secondary method first to ensure continuity.
}
\details{
\strong{Switching Modes:}

\describe{
\item{Peclet ("peclet")}{Theoretical approach. Switches when Peclet number
exceeds threshold (typically 1.0). Based on physical limits of HRM method.}
\item{Velocity ("velocity")}{Empirical approach. Switches when HRM velocity
exceeds threshold (e.g., 11 cm/hr). Matches Tim's Excel template workflow.}
}

\strong{Calibration:}

When \code{calibrate = TRUE}, fits regression between primary and secondary
methods in the overlap region, then uses calibrated secondary values above
the threshold. This prevents the "volcano effect" discontinuity.

\strong{Output Columns:}

\itemize{
\item \code{Vh_sdma}: The velocity value to use (either primary or secondary/calibrated)
\item \code{sdma_source}: Data lineage - which method provided this value
\item \code{sdma_trigger}: Why this method was selected (for diagnostics)
}
}
\examples{
\dontrun{
# Peclet-based switching with calibration (recommended)
vh_sdma <- apply_sdma_switching(
  data = vh_results,
  primary = "HRM",
  secondary = "MHR",
  mode = "peclet",
  threshold = 1.0,
  calibrate = TRUE
)

# Velocity-based switching (Tim's Excel approach)
vh_sdma <- apply_sdma_switching(
  data = vh_results,
  mode = "velocity",
  threshold = 11,  # cm/hr
  calibrate = TRUE,
  calibration_method = "quadratic"
)
}

}
\seealso{
Other sDMA functions: 
\code{\link{auto_select_sdma_strategy}()},
\code{\link{calibrate_secondary_method}()},
\code{\link{recalculate_peclet}()}
}
\concept{sDMA functions}
