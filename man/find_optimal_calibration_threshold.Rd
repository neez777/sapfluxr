% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/04a_method_calibration.R
\name{find_optimal_calibration_threshold}
\alias{find_optimal_calibration_threshold}
\title{Find Optimal Calibration Threshold}
\usage{
find_optimal_calibration_threshold(
  vh_corrected,
  primary_method = "HRM",
  secondary_method,
  sensor_position = "outer",
  threshold_start = 0,
  threshold_max = 20,
  threshold_step = 0.5,
  fit_type = "auto",
  min_points = 50,
  create_plots = TRUE,
  verbose = TRUE,
  manual_threshold = NULL,
  velocity_col = "Vh_cm_hr"
)
}
\arguments{
\item{vh_corrected}{Data frame of corrected velocity data (after spacing
correction). Must contain columns: pulse_id, method, sensor_position, Vh_cm_hr.}

\item{primary_method}{Primary method name (default: "HRM"). This is the
"source of truth" method, typically HRM for low flows.}

\item{secondary_method}{Secondary method name to calibrate (e.g., "MHR").}

\item{sensor_position}{Sensor position to analyse ("outer" or "inner").}

\item{threshold_start}{Minimum velocity threshold to test (cm/hr) (default: 0).}

\item{threshold_max}{Maximum velocity threshold to test (cm/hr) (default: 20).}

\item{threshold_step}{Increment between thresholds (cm/hr) (default: 0.5).}

\item{fit_type}{Type of fit: "linear", "quadratic", or "auto" (default: "auto").
"auto" tries both and selects based on R² improvement.}

\item{min_points}{Minimum number of points required for valid calibration (default: 50).}

\item{create_plots}{Logical indicating whether to create diagnostic plots (default: TRUE).}

\item{verbose}{Logical indicating whether to print progress (default: TRUE).}

\item{manual_threshold}{Numeric value to manually specify threshold (cm/hr).
If provided, skips automatic optimization and uses this threshold directly.
Useful when you want to use a specific threshold based on domain knowledge
or visual inspection of R² vs threshold plot. Default: NULL (automatic).}
}
\value{
A list with components \code{optimal_threshold} (velocity threshold
with highest R²), \code{optimal_r_squared} (R² value at optimal threshold),
\code{optimal_calibration} (full calibration object), \code{threshold_results}
(data frame of tested thresholds with R², RMSE, n_points), \code{plots}
(diagnostic plots if \code{create_plots = TRUE}), \code{primary_method},
\code{secondary_method}, and \code{sensor_position}
}
\description{
Automatically determines the best velocity threshold for calibrating a
secondary method to a primary method by testing multiple thresholds and
comparing R-squared values.
}
\details{
\strong{Threshold Selection Process:}

This function automates the process of finding the optimal velocity threshold
for method calibration:
\enumerate{
\item Tests thresholds from \code{threshold_start} to \code{threshold_max} by
\code{threshold_step} (e.g., 0, 0.5, 1.0, 1.5, ..., 20 cm/hr)
\item At each threshold, filters data to points where primary method <= threshold
\item Fits relationship between primary and secondary methods on this valid region
\item Records R², RMSE, and number of points
\item Identifies the maximum threshold that maintains high R² (where methods still agree)
}

\strong{Interpretation:}

The optimal threshold represents the maximum velocity up to which both methods
are valid and show strong correlation. This is the "divergence point" where
the primary method (typically HRM) begins to fail. Data below the threshold
is used for calibration (where both methods are reliable). The resulting
calibration coefficients are then applied to transform the secondary method
values above the threshold (where the primary fails but secondary continues).

\strong{Diagnostic Plots:}

When \code{create_plots = TRUE}, generates:
\itemize{
\item \strong{R² vs Threshold}: Shows how correlation changes with threshold
\item \strong{Calibration Scatter}: HRM vs MHR with line of best fit at optimal threshold
}
}
\examples{
\dontrun{
# Find optimal threshold for MHR calibration
threshold_result <- find_optimal_calibration_threshold(
  vh_corrected = vh_corrected,
  primary_method = "HRM",
  secondary_method = "MHR",
  sensor_position = "outer",
  threshold_max = 20,
  threshold_step = 0.5
)

# View results
print(threshold_result$optimal_threshold)
print(threshold_result$optimal_r_squared)
print(threshold_result$threshold_results)

# View plots
print(threshold_result$plots$r_squared_plot)
print(threshold_result$plots$calibration_plot)
}

}
\seealso{
Other method calibration functions: 
\code{\link{calibrate_method_to_primary}()},
\code{\link{calibrate_multiple_methods}()},
\code{\link{compare_methods_enhanced}()},
\code{\link{compare_methods_segmented}()},
\code{\link{transform_multiple_methods}()},
\code{\link{transform_secondary_method}()}
}
\concept{method calibration functions}
