% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/01j_vpd_changepoints.R
\name{detect_stable_vpd_periods}
\alias{detect_stable_vpd_periods}
\title{Detect Stable Low VPD Periods for Zero-Flow Calibration}
\usage{
detect_stable_vpd_periods(
  weather_data,
  predawn_window = c(2, 3, 4, 5),
  vpd_threshold = 0.5,
  stability_threshold = 0.1,
  min_n_points = 3,
  min_segment_days = 7,
  max_changepoints = NULL,
  vpd_col = "vpd_kpa"
)
}
\arguments{
\item{weather_data}{Data frame containing weather data with columns:
\code{datetime} (POSIXct) and \code{vpd_kpa} (numeric)}

\item{predawn_window}{Integer vector of hours (0-23) to analyse (default: \code{c(2, 3, 4, 5)}).
These hours are typically pre-dawn when VPD is lowest and most stable.}

\item{vpd_threshold}{Maximum acceptable mean VPD during pre-dawn window (kPa, default: 0.5).
Days with mean pre-dawn VPD above this value are rejected.}

\item{stability_threshold}{Maximum acceptable standard deviation of VPD during
pre-dawn window (kPa, default: 0.1). Higher values indicate unstable conditions.}

\item{min_n_points}{Minimum number of data points required in the pre-dawn window
for a day to be valid (default: 3). Days with fewer points are skipped.}

\item{min_segment_days}{Minimum number of days between selected dates (default: 7).
If valid dates are closer than this, only the most stable day in that period
is retained.}

\item{max_changepoints}{Maximum number of dates to return (default: NULL, no limit).
If more days meet criteria, those with lowest mean VPD are selected.}

\item{vpd_col}{Name of VPD column (default: "vpd_kpa")}
}
\value{
A list (S3 class "stable_vpd_periods") containing:
\item{valid_dates}{Vector of Date objects that passed both magnitude and stability checks}
\item{daily_stats}{Data frame with statistics for every day:
\itemize{
\item \code{date} - Date
\item \code{n_points} - Number of observations in pre-dawn window
\item \code{mean_predawn_vpd} - Mean VPD during pre-dawn hours (kPa)
\item \code{sd_predawn_vpd} - Standard deviation of VPD (kPa)
\item \code{min_predawn_vpd} - Minimum VPD in window (kPa)
\item \code{max_predawn_vpd} - Maximum VPD in window (kPa)
\item \code{passed_magnitude} - Did mean VPD meet threshold?
\item \code{passed_stability} - Did SD meet threshold?
\item \code{passed_both} - Passed both checks?
}
}
\item{segments}{Data frame describing periods between selected dates}
\item{parameters}{List of detection parameters used}
\item{n_days_analysed}{Total number of days with sufficient data}
\item{n_days_passed_both}{Number of days passing both checks}
\item{n_dates_selected}{Number of dates selected after spacing filter}
}
\description{
Identifies dates when VPD during pre-dawn hours is both consistently low
AND stable, indicating suitable conditions for zero-flow calibration.
Unlike \code{\link{detect_vpd_changepoints}} which uses daily minimum values,
this function analyses full-resolution weather data during specific hours
to assess both magnitude and stability.
}
\details{
\strong{Methodology:}

This function implements a "stability-based" approach inspired by legacy
zero-flow detection methods. For each date:
\enumerate{
\item \strong{Extract pre-dawn data}: Filter to specified hours (e.g., 02:00-06:00)
\item \strong{Check magnitude}: Is mean VPD consistently low? (mean ≤ threshold)
\item \strong{Check stability}: Is VPD stable? (SD ≤ stability_threshold)
\item \strong{Validate}: Sufficient data points? (n ≥ min_n_points)
}

Only dates passing ALL criteria are considered valid.

\strong{Differences from detect_vpd_changepoints():}

\itemize{
\item \strong{Daily minima} (changepoints): Uses single minimum value per day
\item \strong{Stability periods} (this function): Analyses full-resolution data during specific hours
}

The stability approach is more conservative - it rejects days where VPD briefly
drops to a low value but is otherwise unstable or elevated.

\strong{Pre-dawn Window Selection:}

Default hours (02:00-06:00) are typically pre-dawn when:
\itemize{
\item VPD is at daily minimum (high humidity, low temperature)
\item Atmospheric conditions are most stable
\item Sap flow is minimal or zero
\item Environmental noise is minimal
}

Adjust \code{predawn_window} based on your site's sunrise time and climate.

\strong{Threshold Selection:}

\itemize{
\item \strong{vpd_threshold}: 0.3 kPa (strict), 0.5 kPa (moderate), 0.8 kPa (permissive)
\item \strong{stability_threshold}: 0.05 kPa (very stable), 0.1 kPa (moderate), 0.15 kPa (permissive)
}

Stricter thresholds yield fewer but higher-quality calibration dates.

\strong{Minimum Segment Days:}

The \code{min_segment_days} parameter ensures temporal independence between
selected dates. When multiple valid dates occur within this window, only
the date with lowest mean VPD is retained.

\strong{Use Cases:}

\itemize{
\item Zero-flow calibration (detecting true zero-flow conditions)
\item Spacing correction (stable environmental baseline)
\item Method comparison (periods with minimal environmental influence)
\item Quality control (identifying stable measurement periods)
}
}
\examples{
\dontrun{
# Import and process weather data
weather <- read_weather_data("weather_station.csv")
weather_vpd <- calc_vpd(weather)

# Detect stable pre-dawn periods (default settings)
stable_periods <- detect_stable_vpd_periods(weather_vpd)

# View selected dates and statistics
print(stable_periods)
print(stable_periods$valid_dates)
View(stable_periods$daily_stats)

# Stricter criteria: lower thresholds, more data required
stable_strict <- detect_stable_vpd_periods(
  weather_vpd,
  vpd_threshold = 0.3,
  stability_threshold = 0.05,
  min_n_points = 6,
  min_segment_days = 14
)

# Custom pre-dawn window (earlier sunrise site)
stable_custom <- detect_stable_vpd_periods(
  weather_vpd,
  predawn_window = c(1, 2, 3, 4),
  vpd_threshold = 0.5,
  stability_threshold = 0.1
)

# Compare with daily minima approach
daily_vpd <- calculate_daily_vpd_minima(weather_vpd)
minima_cpts <- detect_vpd_changepoints(daily_vpd, vpd_threshold = 0.5)

# Compare selected dates
stable_dates <- stable_periods$valid_dates
minima_dates <- minima_cpts$changepoints
both <- intersect(stable_dates, minima_dates)
stability_only <- setdiff(stable_dates, minima_dates)
minima_only <- setdiff(minima_dates, stable_dates)
}

}
\seealso{
\code{\link{detect_vpd_changepoints}} for daily minima approach,
\code{\link{calculate_daily_vpd_minima}} for daily VPD statistics

Other VPD changepoint functions: 
\code{\link{calculate_daily_vpd_minima}()},
\code{\link{detect_vpd_changepoints}()}
}
\concept{VPD changepoint functions}
