% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/03d_heartwood_reference.R
\name{apply_heartwood_reference_correction}
\alias{apply_heartwood_reference_correction}
\title{Apply Heartwood Reference Correction}
\usage{
apply_heartwood_reference_correction(
  vh_data,
  method = "HRM",
  method_col = "method",
  vh_col = "Vh_cm_hr",
  k_assumed = 0.0025,
  probe_spacing = 0.5,
  measurement_time = 80,
  lookup_table = NULL,
  create_new_col = TRUE,
  verbose = TRUE
)
}
\arguments{
\item{vh_data}{Data frame containing heat pulse velocity data with both
inner and outer sensor readings. Must have columns: datetime, pulse_id,
sensor_position, and a velocity column.}

\item{method}{HPV method to correct (default: "HRM").}

\item{method_col}{Name of method column (default: "method").}

\item{vh_col}{Name of velocity column (default: "Vh_cm_hr").}

\item{k_assumed}{Assumed thermal diffusivity (cm2/s, default: 0.0025).}

\item{probe_spacing}{Probe spacing x (cm, default: 0.5).}

\item{measurement_time}{Time after heat pulse for HRM measurement (seconds,
default: 80).}

\item{lookup_table}{Pre-computed Burgess lookup table. If NULL, will be
generated using \code{calculate_burgess_coefficients()}.}

\item{create_new_col}{If TRUE (default), creates new column with "_hrc"
suffix. If FALSE, overwrites vh_col.}

\item{verbose}{Print progress messages (default: TRUE).}
}
\value{
A list with class \code{"heartwood_reference_correction_result"}:
\item{vh_corrected}{Data frame with corrected velocities}
\item{offset_summary}{Summary statistics of observed offsets}
\item{metadata}{Correction metadata and parameters}
}
\description{
Applies spacing correction using the inner sensor as a continuous zero-flow
reference. This method is applicable when the inner sensor is positioned
in the heartwood (verified by \code{check_heartwood_reference_available()}).
}
\details{
For each measurement, the inner sensor Vh is used as the instantaneous
zero offset, and Burgess correction coefficients are applied to correct
the outer sensor reading.

\strong{Method Overview:}

When the inner sensor is in heartwood, it experiences no convective heat
transfer from sap flow. Any Vh measured at the inner sensor represents
the instantaneous probe misalignment (zero offset). This offset can be
used to correct the outer sensor reading continuously.

\strong{Correction Process:}

For each measurement:
\enumerate{
\item Extract inner sensor Vh = zero_offset
\item Look up Burgess correction coefficients (a, b) for that offset
\item Apply to outer sensor: Vh_corrected = a * Vh_outer + b
}

\strong{Comparison with Changepoint Method:}

The heartwood reference method provides continuous (per-measurement)
correction, whereas the changepoint method applies segment-based
correction. Use heartwood reference when:
\itemize{
\item Inner sensor is confirmed to be in heartwood
\item You want real-time offset tracking
\item Probe alignment may drift within segments
}

\strong{Diagnostic Output:}

The \code{offset_summary} in the result provides statistics on the
observed offsets:
\itemize{
\item \code{mean_offset}: Average inner sensor Vh
\item \code{sd_offset}: Standard deviation of offsets
\item \code{range_offset}: Min/max observed offsets
\item \code{quality}: Assessment of offset stability
}
}
\examples{
\dontrun{
# First check if heartwood reference is available
check <- check_heartwood_reference_available(
  probe_config = list(length = 35, inner_sensor = 7.5),
  sapwood_depth = 2.0
)

if (check$available) {
  # Apply heartwood reference correction
  result <- apply_heartwood_reference_correction(
    vh_data = my_vh_data,
    method = "HRM"
  )

  # View corrected data
  head(result$vh_corrected)

  # Check offset statistics
  print(result$offset_summary)
}
}

}
\seealso{
\code{\link{check_heartwood_reference_available}},
\code{\link{apply_spacing_correction_per_segment}},
\code{\link{calculate_burgess_coefficients}}

Other spacing correction functions: 
\code{\link{apply_manual_spacing_correction}()},
\code{\link{apply_spacing_correction}()},
\code{\link{apply_spacing_correction_both_sensors}()},
\code{\link{apply_spacing_correction_workflow}()},
\code{\link{calculate_burgess_coefficients}()},
\code{\link{calculate_zero_offset}()},
\code{\link{get_correction_coefficients}()},
\code{\link{print_spacing_correction_summary}()},
\code{\link{smooth_segment_junctions}()}
}
\concept{spacing correction functions}
