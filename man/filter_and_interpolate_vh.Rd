% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/02a_data_filtering.R
\name{filter_and_interpolate_vh}
\alias{filter_and_interpolate_vh}
\title{Filter and Interpolate Heat Pulse Velocity Data}
\usage{
filter_and_interpolate_vh(
  vh_flagged,
  flags_to_interpolate = c("DATA_MISSING", "DATA_OUTLIER", "DATA_ILLOGICAL"),
  flags_to_preserve = c("DATA_SUSPECT"),
  interpolation_method = "linear",
  max_gap_hours = 1,
  keep_original_values = TRUE,
  keep_interpolated_flag = TRUE,
  group_by_method = TRUE,
  group_by_sensor = TRUE,
  handle_multi_method = c("regenerate", "direct"),
  verbose = TRUE
)
}
\arguments{
\item{vh_flagged}{Data frame from flag_vh_quality() with quality_flag column}

\item{flags_to_interpolate}{Character vector of quality flags to interpolate.
Default: c("DATA_MISSING", "DATA_OUTLIER", "DATA_ILLOGICAL")}

\item{flags_to_preserve}{Character vector of quality flags to leave unchanged.
Default: c("DATA_SUSPECT")}

\item{interpolation_method}{Character string specifying interpolation method:
"linear" (default) or "moving_average". Linear creates a straight line between
valid points. Moving average uses a weighted average of surrounding valid points,
with window size automatically determined based on gap size.}

\item{max_gap_hours}{Numeric, maximum gap duration (hours) to interpolate.
Gaps larger than this are left as NA. Default: 1 hour (typically 2 data points).
Warning issued if > 3 hours.}

\item{keep_original_values}{Logical, whether to preserve original values in
new column (default: TRUE). Adds Vh_original column.}

\item{keep_interpolated_flag}{Logical, whether to add is_interpolated column
(default: TRUE). TRUE for interpolated values, FALSE otherwise.}

\item{group_by_method}{Logical, whether to interpolate within each HPV method
separately (default: TRUE). Recommended to avoid mixing methods.}

\item{group_by_sensor}{Logical, whether to interpolate within each sensor position
separately (default: TRUE). Required - inner/outer should never be mixed.}

\item{handle_multi_method}{Character string specifying how to handle sDMA methods.
Options: "regenerate" (default) or "direct". See Details.}

\item{verbose}{Logical, whether to print progress messages (default: TRUE)}
}
\value{
A tibble with filtered and interpolated velocity data containing:
\item{datetime}{Timestamp of measurement}
\item{pulse_id}{Pulse identification number}
\item{method}{Calculation method}
\item{sensor_position}{Inner or outer sensor position}
\item{Vh_cm_hr}{Cleaned/interpolated velocity (cm/hr)}
\item{Vh_original}{Original velocity before interpolation (if keep_original_values = TRUE)}
\item{quality_flag}{Updated quality flag ("INTERPOLATED" for filled values, "LARGE_GAP" for unfilled)}
\item{quality_flag_original}{Original quality flag before filtering}
\item{is_interpolated}{Logical indicating if value was interpolated (if keep_interpolated_flag = TRUE)}
\item{gap_duration_hours}{Duration of gap that was filled (hours), NA for non-interpolated values}
}
\description{
Applies filtering and interpolation to quality-flagged velocity data.
Removes or interpolates flagged values (outliers, illogical values, missing data)
while preserving suspect values (e.g., negative flows, high Peclet numbers).

\strong{Performance:} Uses optimized C++ implementations for 50-100x speedup on large datasets.
}
\details{
\strong{Interpolation Method:}
Linear interpolation is used to fill small gaps (typically 1-3 hours or 2-6 data points).
For a single missing point, this produces the simple average of surrounding values.
For multiple consecutive missing points, it draws a straight line between the valid
points on either side. This is appropriate for sap flow data which can have sharp
day/night transitions and should not be artificially smoothed.

\strong{Quality Flag Handling:}
\itemize{
\item \strong{DATA_MISSING}: Hardware/logging gaps - interpolated by default
\item \strong{DATA_OUTLIER}: Statistical outliers, rate-of-change spikes - interpolated
\item \strong{DATA_ILLOGICAL}: Exceeds physical limits - interpolated
\item \strong{DATA_SUSPECT}: Negative flows, cross-sensor anomalies - preserved (may be real)
\item \strong{CALC_FAILED/INFINITE/EXTREME}: Calculation failures - left as NA
}

\strong{Gap Thresholds:}
\itemize{
\item Default: 1 hour (typically 2 consecutive 30-min measurements)
\item Warning if > 3 hours (interpolating large gaps is not recommended)
\item Gaps exceeding max_gap_hours are flagged as "LARGE_GAP" and left as NA
}

\strong{sDMA Handling (handle_multi_method parameter):}
\itemize{
\item \strong{"regenerate"}: Interpolate HRM and secondary methods separately,
then re-apply Peclet-based switching to regenerate sDMA values. Recommended
to avoid artifacts at method switching boundaries.
\item \strong{"direct"}: Interpolate sDMA values directly as a single time series.
Simpler but may create discontinuities at Pe = 1.0 threshold.
}

\strong{Grouping:}
Data is always grouped by sensor_position (inner/outer must be separate).
Optionally also group by method to interpolate each HPV method independently.
}
\examples{
\dontrun{
# Basic workflow
vh_results <- calc_heat_pulse_velocity(heat_pulse_data)
vh_flagged <- flag_vh_quality(vh_results)
vh_cleaned <- filter_and_interpolate_vh(vh_flagged)

# Custom interpolation settings (larger gap threshold)
vh_cleaned <- filter_and_interpolate_vh(
  vh_flagged,
  flags_to_interpolate = c("DATA_MISSING", "DATA_OUTLIER"),
  max_gap_hours = 2
)

# With sDMA regeneration
vh_sdma <- apply_sdma_processing(vh_flagged, secondary_method = "MHR")
vh_cleaned <- filter_and_interpolate_vh(
  vh_sdma,
  handle_multi_method = "regenerate"  # Re-applies Peclet switching after interpolation
)
}

}
\seealso{
\code{\link{flag_vh_quality}}, \code{\link{preview_interpolation_changes}},
\code{\link{apply_sdma_processing}}

Other data filtering functions: 
\code{\link{preview_interpolation_changes}()}
}
\concept{data filtering functions}
