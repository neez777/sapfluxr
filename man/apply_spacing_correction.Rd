% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/03b_burgess_correction.R,
%   R/03k_spacing_correction_unified.R
\name{apply_spacing_correction}
\alias{apply_spacing_correction}
\alias{print.unified_spacing_correction_result}
\title{Apply Spacing Correction to Velocity Data}
\usage{
apply_spacing_correction(
  vh_data,
  method = c("pelt", "manual", "vpd", "heartwood"),
  hpv_method = "HRM",
  wood_properties = NULL,
  probe_config = NULL,
  weather_data = NULL,
  ...,
  verbose = TRUE
)

apply_spacing_correction(
  vh_data,
  method = c("pelt", "manual", "vpd", "heartwood"),
  hpv_method = "HRM",
  wood_properties = NULL,
  probe_config = NULL,
  weather_data = NULL,
  ...,
  verbose = TRUE
)

\method{print}{unified_spacing_correction_result}(x, ...)
}
\arguments{
\item{vh_data}{Data frame containing velocity data with columns:
\code{datetime}, \code{sensor_position}, \code{method}, \code{Vh_cm_hr}}

\item{method}{Character string specifying the detection method. One of:
\itemize{
\item \strong{"manual"} - User-specified changepoint dates
\item \strong{"pelt"} - Automatic PELT changepoint detection from daily minima
\item \strong{"vpd"} - Environmental suitability based on low VPD periods
\item \strong{"heartwood"} - Continuous correction using heartwood inner sensor
}}

\item{hpv_method}{Character, velocity calculation method to correct (default: "HRM").
Burgess spacing correction is only validated for HRM.}

\item{wood_properties}{Wood properties object or list containing:
\itemize{
\item \code{derived_properties$thermal_diffusivity_actual_cm2_s} - Thermal diffusivity (cmÂ²/s)
\item \code{tree_measurements$sapwood_depth} - Sapwood depth (cm, required for heartwood method)
\item \code{tree_measurements$bark_thickness} - Bark thickness (cm, optional)
}}

\item{probe_config}{Probe configuration object (required for heartwood method)}

\item{weather_data}{Weather data frame with \code{datetime} and \code{vpd_kpa} columns
(required for VPD method)}

\item{...}{Additional method-specific parameters. See Details.}

\item{verbose}{Logical, whether to print progress messages (default: TRUE)}

\item{correction_params}{Named list of correction parameters per sensor.
Each element should contain: \code{coef_a}, \code{coef_b}, \code{sensor_position}}

\item{method_col}{Name of method column (default: "method")}

\item{vh_col}{Name of velocity column to correct (default: "Vh_cm_hr")}

\item{create_new_col}{Logical, whether to create new corrected column
(default: TRUE). If TRUE, creates "Vh_cm_hr_sc" column. If FALSE,
replaces values in vh_col.}
}
\value{
Data frame with corrections applied. If \code{create_new_col = TRUE},
adds columns:
\itemize{
\item \code{Vh_cm_hr_sc}: Spacing-corrected velocity
\item \code{spacing_correction_applied}: Logical flag
}

A list with class \code{"spacing_correction_result"} containing:
\item{vh_corrected}{Data frame with corrected velocities, including:
\itemize{
\item \code{Vh_cm_hr_raw} - Original raw values
\item \code{Vh_cm_hr_sc} - Spacing-corrected results
\item \code{Vh_cm_hr} - Current best available (hybrid)
\item \code{spacing_correction_a} - Slope coefficient (a) applied
\item \code{spacing_correction_b} - Intercept coefficient (b) applied
\item \code{baseline_offset_cm_hr} - Zero-flow baseline (cm/hr)
\item \code{spacing_correction_applied} - Logical flag
}
}
\item{method_used}{Character, which detection method was used}
\item{changepoints}{Detected or specified changepoints (Date vector)}
\item{segments}{Data frame describing correction segments}
\item{correction_info}{Method-specific correction information}
\item{metadata}{Metadata about correction parameters}
}
\description{
Applies linear correction (Corrected_Vh = a * Vh + b) to velocity data
using sensor-specific correction coefficients.

\strong{Unified interface for all spacing correction methods.} This function provides
a single entry point for applying spacing corrections using any of four detection
methods: Manual, PELT, VPD-based, or Heartwood continuous reference.
}
\details{
The correction formula is:

\code{Vh_corrected = a * Vh_original + b}

where \code{a} and \code{b} are sensor-specific coefficients determined
from zero-flow calibration.

\subsection{Method-Specific Parameters}{
\subsection{Manual Method (\code{method = "manual"})}{

\strong{Required:}
\itemize{
\item \code{manual_changepoints} - Vector of changepoint dates (Date or character "YYYY-MM-DD")
}

\strong{Optional:}
\itemize{
\item \code{baseline_overrides_outer} - Named list of manual baselines for outer sensor per segment
\item \code{baseline_overrides_inner} - Named list of manual baselines for inner sensor per segment
}

\strong{Example:}
\preformatted{
result <- apply_spacing_correction(
  vh_data,
  method = "manual",
  manual_changepoints = c("2024-03-15", "2024-06-10"),
  baseline_overrides_outer = list("1" = 0.8, "2" = 1.2)
)
}
}

\subsection{PELT Method (\code{method = "pelt"})}{

\strong{Automatic changepoint detection from daily velocity minima.}

\strong{Optional:}
\itemize{
\item \code{sensor_position} - Which sensor to use for detection ("outer" or "inner", default: "outer")
\item \code{penalty} - PELT penalty: "MBIC" (most conservative), "BIC", or numeric value (default: "MBIC")
\item \code{min_segment_days} - Minimum days per segment (default: 7)
\item \code{merge_short_segments} - Whether to merge short segments (default: TRUE)
}

\strong{Example:}
\preformatted{
result <- apply_spacing_correction(
  vh_data,
  method = "pelt",
  penalty = "BIC",
  min_segment_days = 10
)
}
}

\subsection{VPD Method (\code{method = "vpd"})}{

\strong{Identifies suitable correction dates based on low VPD (stable environmental conditions).}

\strong{Required:}
\itemize{
\item \code{weather_data} - Data frame with \code{datetime} and \code{vpd_kpa} columns
}

\strong{Optional:}
\itemize{
\item \code{vpd_threshold} - Maximum VPD for changepoints (kPa, default: 0.5)
\itemize{
\item 0.3 kPa - Very conservative, low VPD only
\item 0.5 kPa - Moderate (recommended)
\item 0.8 kPa - Permissive
}
\item \code{min_segment_days} - Minimum days between changepoints (default: 7)
\item \code{require_consecutive} - Require consecutive low-VPD days (default: FALSE)
\item \code{min_consecutive_days} - If require_consecutive, how many days (default: 3)
\item \code{max_changepoints} - Maximum number of changepoints (default: NULL, no limit)
}

\strong{Example:}
\preformatted{
result <- apply_spacing_correction(
  vh_data,
  method = "vpd",
  weather_data = weather,
  vpd_threshold = 0.5,
  min_segment_days = 10
)
}
}

\subsection{Heartwood Method (\code{method = "heartwood"})}{

\strong{Continuous correction using inner sensor as heartwood reference (no segmentation).}

\strong{Required:}
\itemize{
\item \code{wood_properties} - Must contain \code{tree_measurements$sapwood_depth}
\item \code{probe_config} - Probe configuration with geometry information
}

\strong{Optional:}
\itemize{
\item \code{field_of_influence} - Radial extent of heat pulse (cm, default: 1.0)
}

\strong{Example:}
\preformatted{
result <- apply_spacing_correction(
  vh_data,
  method = "heartwood",
  wood_properties = wood,
  probe_config = probe
)
}
}

}

\subsection{Method Comparison}{\tabular{llll}{
   Method \tab When to Use \tab Pros \tab Cons \cr
   \strong{Manual} \tab Known probe movement events \tab Full control, custom baselines \tab Requires prior knowledge \cr
   \strong{PELT} \tab Unknown baseline shifts \tab Automatic, statistically rigorous \tab May detect spurious changes \cr
   \strong{VPD} \tab Environmentally-driven baseline \tab Uses stable conditions \tab Requires weather data \cr
   \strong{Heartwood} \tab Deep heartwood sensor \tab Continuous, no segmentation \tab Requires specific probe depth \cr
}

}

\subsection{Scientific Basis}{
\subsection{Spacing Correction (Burgess et al. 2001)}{

All methods apply the Burgess correction equation:
\deqn{V_c = a \times V_h + b}

Where coefficients \eqn{a} and \eqn{b} depend on the zero-flow offset detected.
}

\subsection{Segmentation vs Continuous}{
\itemize{
\item \strong{Segmented} (manual, PELT, VPD): Divides time series into periods with
separate corrections per segment
\item \strong{Continuous} (heartwood): Single correction using heartwood sensor as
continuous zero reference
}
}

}
}
\examples{
\dontrun{
# Define correction parameters for each sensor
correction_params <- list(
  outer = list(
    sensor_position = "outer",
    coef_a = 1.0234,
    coef_b = -0.8192,
    zero_vh = 0.8
  ),
  inner = list(
    sensor_position = "inner",
    coef_a = 0.9876,
    coef_b = -0.5432,
    zero_vh = 0.5
  )
)

# Apply corrections
vh_corrected <- apply_spacing_correction(
  vh_data = vh_cleaned,
  correction_params = correction_params,
  method = "HRM"
)
}

\dontrun{
# ===== MANUAL METHOD =====
result_manual <- apply_spacing_correction(
  vh_data,
  method = "manual",
  hpv_method = "HRM",
  wood_properties = wood,
  manual_changepoints = c("2024-03-15", "2024-06-10")
)

# ===== PELT METHOD =====
result_pelt <- apply_spacing_correction(
  vh_data,
  method = "pelt",
  hpv_method = "HRM",
  wood_properties = wood,
  penalty = "MBIC",
  min_segment_days = 7
)

# ===== VPD METHOD =====
result_vpd <- apply_spacing_correction(
  vh_data,
  method = "vpd",
  hpv_method = "HRM",
  wood_properties = wood,
  weather_data = weather,
  vpd_threshold = 0.5
)

# ===== HEARTWOOD METHOD =====
result_heartwood <- apply_spacing_correction(
  vh_data,
  method = "heartwood",
  hpv_method = "HRM",
  wood_properties = wood,
  probe_config = probe
)

# View results
print(result_pelt)
plot_spacing_correction_comparison(result_pelt, sensor_position = "outer")
}

}
\seealso{
\code{\link{apply_spacing_correction_both_sensors}} for PELT method details,
\code{\link{apply_manual_spacing_correction}} for manual method,
\code{\link{detect_vpd_changepoints}} for VPD method,
\code{\link{check_heartwood_reference_available}} for heartwood method

Other spacing correction functions: 
\code{\link{apply_heartwood_reference_correction}()},
\code{\link{apply_manual_spacing_correction}()},
\code{\link{apply_spacing_correction_both_sensors}()},
\code{\link{calculate_burgess_coefficients}()},
\code{\link{calculate_zero_offset}()},
\code{\link{get_correction_coefficients}()},
\code{\link{print_spacing_correction_summary}()},
\code{\link{smooth_segment_junctions}()},
\code{\link{validate_zero_offset}()}

Other spacing correction functions: 
\code{\link{apply_heartwood_reference_correction}()},
\code{\link{apply_manual_spacing_correction}()},
\code{\link{apply_spacing_correction_both_sensors}()},
\code{\link{calculate_burgess_coefficients}()},
\code{\link{calculate_zero_offset}()},
\code{\link{get_correction_coefficients}()},
\code{\link{print_spacing_correction_summary}()},
\code{\link{smooth_segment_junctions}()},
\code{\link{validate_zero_offset}()}
}
\concept{spacing correction functions}
