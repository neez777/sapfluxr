% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/04a_method_calibration.R
\name{compare_methods_segmented}
\alias{compare_methods_segmented}
\title{Compare Methods Using Segmented Regression}
\usage{
compare_methods_segmented(
  vh_corrected,
  primary_method = "HRM",
  secondary_method,
  sensor_position = "outer",
  initial_breakpoint = NULL,
  min_points = 50,
  create_plots = TRUE,
  verbose = TRUE,
  velocity_col = "Vh_cm_hr"
)
}
\arguments{
\item{vh_corrected}{Data frame of corrected velocity data (after spacing
correction). Must contain columns: pulse_id, method, sensor_position, Vh_cm_hr.}

\item{primary_method}{Primary method name (default: "HRM"). This is typically
the method that plateaus at higher velocities.}

\item{secondary_method}{Secondary method name to compare (e.g., "MHR").}

\item{sensor_position}{Sensor position to analyse ("outer" or "inner").}

\item{initial_breakpoint}{Initial guess for breakpoint location (cm/hr).
If NULL, uses midpoint of data range. Default: NULL.}

\item{min_points}{Minimum number of points required for valid analysis (default: 50).}

\item{create_plots}{Logical indicating whether to create diagnostic plots (default: TRUE).}

\item{verbose}{Logical indicating whether to print progress (default: TRUE).}
}
\value{
A list with components \code{breakpoint} (estimated breakpoint
velocity in cm/hr), \code{breakpoint_ci} (95\\% confidence interval),
\code{breakpoint_se} (standard error), \code{slope_before} (slope before
breakpoint), \code{slope_after} (slope after breakpoint), \code{r_squared}
(overall R² of segmented model), \code{davies_test} (p-value from Davies
test), \code{n_points} (number of points), \code{segmented_model} (full
model object), \code{merged_data} (paired measurements data frame),
\code{plots} (list of diagnostic plots if \code{create_plots = TRUE}),
\code{primary_method}, \code{secondary_method}, and \code{sensor_position}
}
\description{
Identifies the velocity breakpoint where two methods diverge using segmented
(piecewise) linear regression. This statistically determines where one method
(typically HRM) begins to plateau while the other (e.g., MHR) continues to
measure higher velocities - the classic "hockey stick" pattern.
}
\details{
\strong{Scientific Background:}

Segmented regression (piecewise linear regression) is the gold standard
approach for identifying method validity ranges in sap flow research. Unlike
testing arbitrary thresholds, this approach:

\itemize{
\item Statistically estimates THE breakpoint where methods diverge
\item Provides confidence intervals for the breakpoint location
\item Tests whether the breakpoint is statistically significant (Davies test)
\item Quantifies how slopes change before and after the breakpoint
}

\strong{Interpretation:}

The breakpoint represents the maximum velocity where both methods maintain
a linear relationship. Above this point, the primary method (typically HRM)
begins to underestimate compared to the secondary method. This identifies:

\itemize{
\item The valid measurement range for the primary method
\item The velocity where method switching (sDMA) should occur
\item The calibration region for aligning methods
}

\strong{Advantages over R² Optimization:}

\itemize{
\item \strong{Statistical rigor}: Confidence intervals and significance testing
\item \strong{Objective}: No arbitrary threshold selection
\item \strong{Defensible}: Widely accepted in method comparison studies
\item \strong{Precise}: Identifies the actual divergence point, not maximum correlation
}

\strong{Diagnostic Plots:}

When \code{create_plots = TRUE}, generates:
\itemize{
\item \strong{Segmented regression plot}: Shows data, fitted segments, breakpoint,
and confidence interval shading
\item \strong{Residuals plot}: Helps assess model assumptions
}
}
\examples{
\dontrun{
# Compare MHR to HRM using segmented regression
comparison <- compare_methods_segmented(
  vh_corrected = vh_corrected,
  primary_method = "HRM",
  secondary_method = "MHR",
  sensor_position = "outer"
)

# View results
print(comparison$breakpoint)  # e.g., 12.3 cm/hr
print(comparison$breakpoint_ci)  # e.g., [10.8, 13.8]
print(comparison$davies_test)  # p-value for significance

# View plot
print(comparison$plots$segmented_plot)
}

}
\references{
Muggeo, V.M.R. (2003). Estimating regression models with unknown break-points.
Statistics in Medicine, 22(19), 3055-3071.

Burgess, S.S.O., et al. (2001). Comparison of sap flow measurement methods.
Tree Physiology, 21(9), 589-598.
}
\seealso{
Other method calibration functions: 
\code{\link{calibrate_method_to_primary}()},
\code{\link{calibrate_multiple_methods}()},
\code{\link{compare_methods_enhanced}()},
\code{\link{find_optimal_calibration_threshold}()},
\code{\link{transform_multiple_methods}()},
\code{\link{transform_secondary_method}()}
}
\concept{method calibration functions}
