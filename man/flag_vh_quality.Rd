% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/01f_data_quality.R
\name{flag_vh_quality}
\alias{flag_vh_quality}
\title{Flag Vh Quality Issues}
\usage{
flag_vh_quality(
  vh_results,
  wood_properties = NULL,
  detect_missing_pulses = TRUE,
  expected_interval_hours = NULL,
  check_illogical = TRUE,
  hard_max_vh = 500,
  flag_negative = TRUE,
  outlier_method = "all",
  seasonal_period = NULL,
  remainder_threshold = 3,
  use_mad = TRUE,
  hampel_window = 7,
  hampel_threshold = 3,
  check_cross_sensor = TRUE,
  cross_sensor_threshold = 3,
  add_rows_for_missing = TRUE,
  return_gap_report = TRUE,
  verbose = TRUE
)
}
\arguments{
\item{vh_results}{Data frame from calc_heat_pulse_velocity() with columns:
datetime, pulse_id, method, sensor_position, Vh_cm_hr}

\item{wood_properties}{Optional WoodProperties object or path to YAML file
for species-specific thresholds}

\item{detect_missing_pulses}{Logical, whether to detect gaps in time series (default: TRUE)}

\item{expected_interval_hours}{Numeric, expected hours between pulses.
If NULL, auto-detected from data (default: NULL)}

\item{check_illogical}{Logical, whether to check for physically impossible values (default: TRUE)}

\item{hard_max_vh}{Numeric, absolute maximum Vh in cm/hr (default: 500)}

\item{flag_negative}{Logical, whether to flag negative flows as SUSPECT (default: TRUE)}

\item{outlier_method}{Character vector of methods: "stl", "mstl", "hampel".
Use "all" for all methods (default: "all")}

\item{seasonal_period}{Integer, number of measurements per daily cycle.
If NULL, auto-detected (default: NULL, typically 48 for 30-min data)}

\item{remainder_threshold}{Numeric, IQR or MAD multiplier for STL remainder outliers.
3 = Tukey "far out" rule (default: 3)}

\item{use_mad}{Logical, use MAD instead of IQR for robustness (default: TRUE)}

\item{hampel_window}{Integer, half-width of Hampel filter window (default: 7)}

\item{hampel_threshold}{Numeric, MAD multiplier for Hampel filter (default: 3)}

\item{check_cross_sensor}{Logical, detect cross-sensor inconsistencies (default: TRUE)}

\item{cross_sensor_threshold}{Numeric, MAD multiplier for cross-sensor comparison (default: 3)}

\item{add_rows_for_missing}{Logical, add rows for missing pulses (default: TRUE)}

\item{return_gap_report}{Logical, include detailed gap report (default: TRUE)}

\item{verbose}{Logical, print progress messages (default: TRUE)}
}
\value{
List containing:
\describe{
\item{vh_flagged}{Data frame with added quality_flag column}
\item{gap_report}{Data frame of missing data periods (if return_gap_report = TRUE)}
\item{outlier_summary}{Summary statistics per sensor and method}
\item{flag_counts}{Count of each flag type}
\item{metadata}{Detection parameters and methods used}
}
}
\description{
Comprehensive quality control for heat pulse velocity (Vh) results.
Detects missing pulses, illogical values, and statistical outliers while
accounting for the natural daily cyclical pattern in sap flow data.
}
\details{
\strong{Quality Flag Hierarchy (most severe wins):}
\enumerate{
\item \strong{MISSING} - No data for expected pulse timestamp
\item \strong{ILLOGICAL} - Exceeds hard_max_vh or species max_velocity_cm_hr
\item \strong{OUTLIER} - Statistical outlier in STL/MSTL remainder or Hampel filter
\item \strong{SUSPECT} - Negative flow (possible misalignment) or cross-sensor anomaly
\item \strong{OK} - No issues detected
}

\strong{Outlier Detection Methods:}
\itemize{
\item \strong{STL/MSTL}: Seasonal-Trend decomposition using LOESS. Decomposes data into
Seasonal + Trend + Remainder components. Outliers detected in Remainder using
Tukey's far-out rule (Q3 + 3Ã—IQR) or MAD-based threshold.
\item \strong{Hampel Filter}: Rolling median + MAD in sliding window. Detects isolated
spikes by comparing each point to local median.
\item \strong{Cross-Sensor}: Compares sensors at same timestamp. Flags sensors that
deviate significantly from median across all sensors.
}

\strong{Why cyclical-aware detection matters:}
Sap flow has strong daily cycles (high during day, low at night). Standard
outlier detection would flag normal daily variation as outliers. These methods
remove the daily cycle first, then detect true anomalies in the remainder.
}
\examples{
\dontrun{
# Basic usage with all defaults
vh_results <- calc_heat_pulse_velocity(heat_pulse_data)
qc_results <- flag_vh_quality(vh_results)

# View flagged data
table(qc_results$vh_flagged$quality_flag)

# With species-specific thresholds
qc_results <- flag_vh_quality(
  vh_results,
  wood_properties = "eucalyptus"
)

# Custom outlier detection
qc_results <- flag_vh_quality(
  vh_results,
  outlier_method = c("stl", "hampel"),
  remainder_threshold = 2.5,  # More sensitive
  hampel_window = 5
)

# Check gap report
print(qc_results$gap_report)
}

}
\seealso{
\code{\link{interpolate_missing_vh}}
}
\concept{data quality functions}
