% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/01f_data_quality.R
\name{flag_vh_quality}
\alias{flag_vh_quality}
\title{Flag Vh Quality Issues}
\usage{
flag_vh_quality(
  vh_results,
  wood_properties = NULL,
  detect_missing_pulses = TRUE,
  expected_interval_hours = NULL,
  interval_tolerance_seconds = 5,
  check_illogical = TRUE,
  hard_max_vh = 500,
  flag_negative = TRUE,
  detect_outliers = TRUE,
  rolling_window = 5,
  rolling_threshold = 3,
  detect_rate_of_change = TRUE,
  max_change_cm_hr = 4,
  check_cross_sensor = FALSE,
  cross_sensor_threshold = 3,
  add_rows_for_missing = TRUE,
  max_gap_to_fill_hours = 24,
  return_gap_report = TRUE,
  return_full_report = FALSE,
  verbose = TRUE
)
}
\arguments{
\item{vh_results}{Data frame from calc_heat_pulse_velocity() with columns:
datetime, pulse_id, method, sensor_position, Vh_cm_hr}

\item{wood_properties}{Optional WoodProperties object or path to YAML file
for species-specific thresholds}

\item{detect_missing_pulses}{Logical, whether to detect gaps in time series (default: TRUE)}

\item{expected_interval_hours}{Numeric, expected hours between pulses.
If NULL, auto-detected from data (default: NULL)}

\item{interval_tolerance_seconds}{Numeric, tolerance in seconds for matching pulse times.
Allows for clock drift and jitter (default: 5 seconds)}

\item{check_illogical}{Logical, whether to check for physically impossible values (default: TRUE)}

\item{hard_max_vh}{Numeric, absolute maximum Vh in cm/hr (default: 500)}

\item{flag_negative}{Logical, whether to flag negative flows as SUSPECT (default: TRUE)}

\item{detect_outliers}{Logical, whether to detect statistical outliers (default: TRUE)}

\item{rolling_window}{Integer, half-width of rolling window for median calculation
(default: 5, meaning 11-point window)}

\item{rolling_threshold}{Numeric, SD multiplier for rolling mean outlier detection.
Points deviating more than threshold × SD from rolling mean are flagged (default: 3)}

\item{detect_rate_of_change}{Logical, whether to detect excessive rate of change (default: TRUE)}

\item{max_change_cm_hr}{Numeric, maximum allowed change in Vh between consecutive pulses (cm/hr).
Default: 4 cm/hr - larger jumps are unlikely to be real sap flow changes}

\item{check_cross_sensor}{Logical, detect cross-sensor inconsistencies (default: TRUE)}

\item{cross_sensor_threshold}{Numeric, SD multiplier for cross-sensor comparison (default: 3)}

\item{add_rows_for_missing}{Logical, add rows for missing pulses (default: TRUE)}

\item{max_gap_to_fill_hours}{Numeric, maximum gap duration (hours) to fill with MISSING rows.
Gaps larger than this are reported but not filled to avoid creating excessive missing rows.
Default: 24 hours}

\item{return_gap_report}{Logical, include detailed gap report (default: TRUE)}

\item{return_full_report}{Logical, return full report list or just flagged data frame (default: FALSE).
If FALSE, returns only the vh_flagged data frame. If TRUE, returns full list with gap_report,
outlier_summary, flag_counts, and metadata. Use FALSE for simple workflows and Shiny apps.}

\item{verbose}{Logical, print progress messages (default: TRUE)}
}
\value{
If return_full_report = FALSE (default), returns data frame with quality_flag column added.
If return_full_report = TRUE, returns list containing:
\describe{
\item{vh_flagged}{Data frame with added quality_flag column}
\item{gap_report}{Data frame of missing data periods (if return_gap_report = TRUE)}
\item{outlier_summary}{Summary statistics per sensor and method}
\item{flag_counts}{Count of each flag type}
\item{metadata}{Detection parameters and methods used}
}
}
\description{
Comprehensive quality control for heat pulse velocity (Vh) results.
Detects missing pulses, illogical values, and statistical outliers using
simple rolling median and rate of change detection.
}
\details{
\strong{Two-Tier Quality Flag System:}

\strong{Tier 1 - Calculation Quality (CALC_ prefix):}
Set during \code{calc_heat_pulse_velocity()}, indicates issues with the calculation itself:
\itemize{
\item \strong{CALC_FAILED} - Calculation returned NA (e.g., Tmax couldn't find peak)
\item \strong{CALC_INFINITE} - Calculation returned Inf (division by zero, etc.)
\item \strong{CALC_EXTREME} - Result outside physically realistic range (|Vh| > 200 or Vh < -50)
}

\strong{Tier 2 - Data Quality (DATA_ prefix):}
Set during \code{flag_vh_quality()}, indicates issues with time series patterns:
\itemize{
\item \strong{DATA_MISSING} - No pulse recorded at expected timestamp (hardware/logging gap)
\item \strong{DATA_ILLOGICAL} - Exceeds hard_max_vh or species max_velocity_cm_hr
\item \strong{DATA_OUTLIER} - Statistical outlier (rolling median or rate of change)
\item \strong{DATA_SUSPECT} - Negative flow or cross-sensor anomaly
}

\strong{OK} - No issues detected in either tier

CALC_ flags are preserved when flag_vh_quality() is run. DATA_ flags are only
applied to rows currently flagged as OK.

\strong{Outlier Detection Methods:}
\enumerate{
\item \strong{Rolling Mean}: Compares each point to the mean of a sliding window.
Points that deviate by more than \code{rolling_threshold × SD} from the local
mean are flagged. This detects isolated spikes while respecting local
trends and daily variation. Default threshold of 3 corresponds to 99.7\%
confidence interval.
\item \strong{Rate of Change}: Flags consecutive measurements that change by more than
\code{max_change_cm_hr}. Sap flow typically changes gradually, so large jumps
(e.g., > 4 cm/hr between 30-min intervals) are likely sensor errors.
\item \strong{Cross-Sensor}: Compares sensors at the same timestamp. Sensors that deviate
significantly from the median across all sensors are flagged as SUSPECT.
}

\strong{Why simple methods work:}
Sap flow data typically has:
\itemize{
\item Regular measurement intervals (e.g., 30 min)
\item Gradual changes in velocity (smooth daily cycles)
\item Isolated outliers (sensor spikes, logging errors)
}

Rolling mean and rate of change detection are sufficient to catch these issues
without needing complex seasonal decomposition.

\strong{Handling Large Gaps:}
Gaps larger than \code{max_gap_to_fill_hours} are reported in the gap_report but
NOT filled with MISSING rows to avoid creating thousands of missing entries.
Only small gaps (< max_gap_to_fill_hours) are filled.
}
\examples{
\dontrun{
# Basic usage - returns data frame with quality_flag column
vh_results <- calc_heat_pulse_velocity(heat_pulse_data)
vh_flagged <- flag_vh_quality(vh_results)
table(vh_flagged$quality_flag)

# Get full report for detailed analysis
qc_results <- flag_vh_quality(vh_results, return_full_report = TRUE)
print(qc_results)  # Shows summary
table(qc_results$vh_flagged$quality_flag)
print(qc_results$gap_report)

# With species-specific thresholds
vh_flagged <- flag_vh_quality(
  vh_results,
  wood_properties = "eucalyptus"
)

# Custom outlier detection with full report
qc_results <- flag_vh_quality(
  vh_results,
  rolling_window = 7,           # Wider window
  rolling_threshold = 2.5,      # More sensitive
  max_change_cm_hr = 3,         # Stricter rate of change
  max_gap_to_fill_hours = 12,   # Don't fill gaps > 12 hours
  return_full_report = TRUE
)
}

}
\seealso{
\code{\link{interpolate_missing_vh}}
}
\concept{data quality functions}
